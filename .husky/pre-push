#!/bin/bash

# Build the React project
npm run build

# Check if the bucket exists
USER_BUCKET_NAME="user-$(git config user.name | tr '[:upper:]' '[:lower:]')-$(git symbolic-ref --short HEAD | tr '/' '-')"
if aws s3api head-bucket --bucket $USER_BUCKET_NAME --profile AccountLevelFullAccess-503226040441 2>/dev/null; then
  echo "Bucket already exists: $USER_BUCKET_NAME"
else
  echo "Creating bucket: $USER_BUCKET_NAME"
  aws s3api create-bucket --bucket $USER_BUCKET_NAME --region ap-south-1 --create-bucket-configuration LocationConstraint=ap-south-1 --profile AccountLevelFullAccess-503226040441
  aws s3api put-public-access-block --bucket $USER_BUCKET_NAME --public-access-block-configuration "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false" --profile AccountLevelFullAccess-503226040441
  aws s3api put-bucket-policy --bucket $USER_BUCKET_NAME --policy '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": "*",
        "Action": "s3:GetObject",
        "Resource": "arn:aws:s3:::'"$USER_BUCKET_NAME"'/*"
      }
    ]
  }' --profile AccountLevelFullAccess-503226040441
  aws s3api put-bucket-website --bucket $USER_BUCKET_NAME --website-configuration '{
    "ErrorDocument": {"Key": "index.html"},
    "IndexDocument": {"Suffix": "index.html"}
  }' --profile AccountLevelFullAccess-503226040441
fi

# Deploy the build to the user's branch-specific bucket
aws s3 sync build/ s3://$USER_BUCKET_NAME --profile AccountLevelFullAccess-503226040441

# Generate the deployment URL
DEPLOYMENT_URL="http://$USER_BUCKET_NAME.s3-website.ap-south-1.amazonaws.com"
echo "Deployment URL: $DEPLOYMENT_URL"

# Update JSON file with the deployment URL
USERNAME=$(git config user.name)
BRANCH_NAME=$(git symbolic-ref --short HEAD)
FILENAME="submissions.json"

# Function to add key-value pair to JSON object
add_key_value_to_json() {
    local key="$1"
    local value="$2"
    local json_file="$3"
    local temp_file="${json_file}.tmp"

    # Check if the key already exists in the JSON file
    if grep -q "\"$key\":" "$json_file"; then
        # If the key exists, update the value for the existing key using sed
        sed "s|\"$key\":.*|\"$key\":\"$value\",|" "$json_file" > "$temp_file"
    else
        # If the key doesn't exist, add the new key-value pair to the JSON object
        sed "s|{|{\"$key\":\"$value\",|" "$json_file" > "$temp_file"
    fi

    # Overwrite the original file with the updated content
    mv "$temp_file" "$json_file"
}

# Check if the JSON file exists in the bucket
if aws s3 ls s3://kdu-automation/frontend/"$FILENAME" --profile AccountLevelFullAccess-503226040441; then
    # Download the JSON file from the bucket
    aws s3 cp s3://kdu-automation/frontend/"$FILENAME" ./temp.json --profile AccountLevelFullAccess-503226040441

    # Add the key-value pair to the JSON object
    DEPLOYMENT_URL="http://$USER_BUCKET_NAME.s3-website.ap-south-1.amazonaws.com"
    add_key_value_to_json "$USERNAME-$BRANCH_NAME" "$DEPLOYMENT_URL" ./temp.json

    # Upload the updated JSON file back to the bucket
    aws s3 cp ./temp.json s3://kdu-automation/frontend/"$FILENAME" --profile AccountLevelFullAccess-503226040441

    echo "JSON file uploaded successfully."
else
    # Create a new JSON file with the key-value pair
    DEPLOYMENT_URL="http://$USER_BUCKET_NAME.s3-website.ap-south-1.amazonaws.com"
    echo "{\"$USERNAME-$BRANCH_NAME\":\"$DEPLOYMENT_URL\"}" > ./temp.json

    # Upload the new JSON file directly to the bucket
    aws s3 cp ./temp.json s3://kdu-automation/frontend/"$FILENAME" --profile AccountLevelFullAccess-503226040441

    echo "JSON file uploaded successfully."
fi


